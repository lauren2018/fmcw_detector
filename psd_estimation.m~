%% 
%% written by Taehwan Kim (taehwan@berkeley.edu)

clear; close all; clc;

%% open simulink model
open_system('./model/symodel');

%% set constants
c = 3e8;
timestep = 0.001e-6;
stoptime = 10e-6;
Fs = 1/timestep;
alpha = 1e16;
omega0 = 0;
phi0 = 0;

distance = 1;
tau = distance/c;
fnoise = 1e6;
snoise = 0e-8;

%% run simulation
iter = 2;
x = zeros(iter, stoptime/timestep);

for i=1:iter
    sim('symodel');
end
    
%% plot the periodogram-estmated psd for 
figure(1);
% x=vout.Data(1:end-1);
N = length(x);
xdft = fft(x);
xdft = xdft(1:N/2+1);
psdx = (1/(Fs*N)) * abs(xdft).^2;
psdx(2:end-1) = 2*psdx(2:end-1);
freq = 0:Fs/length(x):Fs/2;
[Y,I] = max(psdx);
f_est_periodogram = freq(I);

plot(freq,10*log10(psdx));

title('Photocurrent PSD');
axis([0 freq(end) -140 -40]);
xlabel('Frequency (Hz)');
grid on;
ylabel('PSD (dB/Hz)');

figure(2);
[S,F] = pmusic(x,6,freq,Fs);
[Y,I] = max(S);
f_est_music = F(I);
plot(freq,S);

title('MUSIC');
xlim([0 freq(end)]);
xlabel('Frequency (Hz)');
grid on;