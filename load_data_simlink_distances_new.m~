%% written by Taehwan Kim (taehwan@berkeley.edu)
header;
c = 3e8;
% alpha = 10e6/(352/3e8);

% datapathname = '~/isg/MOABB/lidar_experiments/experiments/data/laser/linewidth/cleo_dec9/result_320m_100u_191mA_2.mat';
% datapathname = '~/isg/MOABB/lidar_experiments/experiments/data/laser/linewidth/ming_dec5/result_ming_300m_50u_40mA.mat';
% datapathname = strcat('~/isg/MOABB',dataname);
% addpath(datapathname);

%% open simlink model
open_system('./model/symodel_simple');

%% set constants
q = 1.6e-19;
Res = 1;
c = 3e8;
timestep = 1e-9;

chirpbw = 10e9; %%%%%%%
realstop = 100*1e-6;
alpha = chirpbw/realstop;

distance = 200;
tau = 2*distance/c;
buffer = 14336;
                                                                                
stoptime = realstop + tau; %%%%%%%

Fs = 1/timestep;
omega0 = 0;
phi0 = 0;
prx=1/sqrt(2);

N = round(realstop/timestep);

% fnoise_list = 10.^(6:0.1:7); %%%%%%%
% fnoise_list = [5e5 1e6 5e6];
fnoise_list = 1e6;
% Prx = 1e-3;
% Prx = [10^-9 10^-10 10^-11];
% Prx = 10.^(-11:0.2:-8);
% Prx = 10^-10.6;
% Prx = 1e-9;
% Prx = 10.^(-11.5:0.5:);
Plo = 10e-3;
Prx = 1e-9;
% [10^-10 10^-9 10^-8];
% snoise_list = q/Res./Prx;
snoise_list = 2*q*Res*Plo;


%% run simulation

iter = 50;

periods = (1./(tau*alpha))/timestep;
rightlength = floor(periods.*floor(N./periods));

x_windowed = zeros(length(fnoise_list), iter, N);
signal_est_periodogram = zeros(length(fnoise_list), iter);
dist_est_periodogram = zeros(length(Prx),length(fnoise_list), iter);
dist_est_periodogram_lse = zeros(length(Prx),length(fnoise_list), iter);
dist_est_rb = zeros(length(Prx),length(fnoise_list), iter);

std_est_periodogram = zeros(length(Prx),length(fnoise_list));
std_est_periodogram_lse = zeros(length(Prx),length(fnoise_list));
std_est_rb = zeros(length(Prx),length(fnoise_list));
max_est_periodogram = zeros(length(Prx),length(fnoise_list));

percollection = zeros(length(Prx),length(fnoise_list),iter,N/2+1);
solution_lse_collection = zeros(length(Prx),length(fnoise_list),iter,2);

tolerance = 1;

rng(510);
A = randi(10000,2,iter);

for k=1:length(Prx)
    for j=1:length(fnoise_list)
        i = 1;
        fail_flag = 0;
        
        fnoise = fnoise_list(j);
        tauc=1./(pi*fnoise);
        dc = (c/(4*pi*fnoise))*log(realstop*pi*fnoise);
        
        while (i <= iter && fail_flag == 0)
            
            snoise = snoise_list(k);
            fseed = A(1,i);
            sseed = A(2,i);
            
            
            outlier_flag = 1;
            outlier_count = 0;
            
            while (outlier_flag == 1)
                                
                sim('symodel_simple');
                measdata = squeeze(vout15.Data);
                measdata = measdata(end-N:end-N+rightlength-1);
                
                x_windowed(j,i,:)= cat(2,measdata',zeros(1,N-length(measdata)));

%                     zeros(round(4*N/5)-rightlength,1)
                tempx_windowed = squeeze(x_windowed(j,i,:));

                [per,F] = periodogram(tempx_windowed,window(@rectwin,length(tempx_windowed)),length(tempx_windowed),Fs);

                [Y, I] = max(per);
                signal_est_periodogram(j,i) = Y;
                dist_est_periodogram(k,j,i) = F(I)*c/alpha/2;        
                
                dist_est_rb(k,j,i) = frequency_rb(tempx_windowed,Fs)*c/alpha/2;
                    
                solution_lse = pnoise_fit(10*log10(per),F,fnoise,snoise,[I 0.5*Y*(2*pi*fnoise)^2]);
                dist_est_periodogram_lse(k,j,i) = c*solution_lse(1)*(F(2)-F(1))/alpha/2;
                
                outlier_flag_lse = outlier_test(distance, dist_est_periodogram_lse(k,j,i), tolerance);
                
                if (outlier_flag_lse == 0)
                    outlier_flag = 0;
%                     fprintf('No outliers! ');
                elseif (outlier_count == 50)
                    fprintf('Failed! %d-%d\n', k,j);
                    outlier_flag = 0;
                    fail_flag = 1;
                else
                    fprintf('Outlier exists %d, %.2f\n',outlier_count,100*abs(distance-dist_est_periodogram_lse(k,j,i)));
                    fseed = fseed + 1;
                    sseed = sseed + 1;
                    outlier_count = outlier_count + 1;
                end
                
            end
            i = i + 1;
            percollection(k,j,i,:) = per;
            solution_lse_collection(k,j,i,:) = solution_lse;
        end
        
        fprintf('Just finished iteration #%d-%d, fail_flag: %d, ', k,j,fail_flag);
        if fail_flag == 1
            std_est_periodogram_lse(k,j) = 100;
        else
            std_est_periodogram_lse(k,j) = std(dist_est_periodogram_lse(k,j,:));
        end
        max_est_periodogram(k,j) = mean(signal_est_periodogram(j,:));
        
        std_est_periodogram(k,j) = std(dist_est_periodogram(k,j,:));
        std_est_rb(k,j) = std(dist_est_rb(k,j,:));
        
        fprintf('lse: %.2f cm\n',single(std_est_periodogram_lse(k,j)*100));
        fprintf('per: %.2f cm\n',single(std_est_periodogram(k,j)*100));
        fprintf('rb: %.2f cm\n',single(std_est_rb(k,j)*100));
    end
end

figure(1);
set(gcf,'DefaultAxesColorOrder',colororder);
hold on
plot(F/1e6,30+10*log10(per));
plot(F/1e6,30+10*log10(squeeze(mean(percollection,3))));
plot(F/1e6,30+pnoise_model(fnoise,snoise,solution_lse,F));
% plot(F,pnoise_model(fnoise,snoise,[solution_lse(1) 2*Res^2*Plo*Prx*2*pi*fnoise],F));

xlabel('Frequency (MHz)');
ylabel('Power Density (dBm/Hz)');
legend('Single trial','Averaged (50 trials)','Fitted');
legend boxoff;
box off;
xlim([0 500]);
ylim([-200 -120]);

%%
% sample = load(datapathname);
% 
% % filename = sprintf('./data/pc_10m_50khz_133mvpp_820mv/scope_26.csv');
% wmeas = transpose(sample.wmeas(:,:));
% tmeas = transpose(sample.tmeas(2:end,:));
% 
% wstd = sqrt(var(wmeas,[],2));
% nor = (1/wstd(1))*eye(length(wstd));
% % nor = diag(1./wstd);
% wmeas = nor*wmeas;
% leng = length(tmeas)-1;
% wmeas = wmeas(:,1:leng);
% tmeas = tmeas(:,1:leng);
% % wmeas = wmeas(:,end-leng:end);
% % tmeas = tmeas(:,end-leng:end);
% % scope = csvread(filename,5,0);
% % scope = scope';
% [lenx, leny] = size(wmeas);
% 
% [per,F]=periodogram(wmeas(1,:),window(@rectwin,length(wmeas(1,:))),length(wmeas(1,:)),1/(tmeas(2)-tmeas(1)));
% 
% % data = zeros(lenx,leny);
% per_data = zeros(lenx,length(per)-49-50);
% % per_data_lp = zeros(lenx,length(per)-49-300);
% % window_lp=zeros(1,size(per_data,2));
% % template = normpdf(linspace(1,3898,3898),0,3);
% % window_lp(1:1949)= template(1:1949);
% % window_lp(end-1948:end)=fliplr(template(1:1949));
% 
% solutions_per = zeros(lenx,1);
% % solutions_per_lp = zeros(lenx,1);
% solutions_rb = zeros(lenx,1);
% solutions_lse = zeros(lenx,1);
% solution_lse = zeros(lenx,2);
% tau = zeros(lenx,1);
% 
% roisize=500;
% for i=1:lenx
% % for i=92
% 
% %     filename = sprintf('scope_%d.csv', i+25);
% %     filename = strcat(datapathname, filename);
% %     scope = csvread(filename,5,0);
% %     scope = scope';
% %     data(i,:) = wmeas(i,:);
%     [per_temp,f_temp] = periodogram(wmeas(i,:),window(@rectwin,length(wmeas(i,:))),length(wmeas(i,:)),1/(tmeas(2)-tmeas(1)));
%     per_temp = per_temp(50:end-50);
%     f_temp = f_temp(50:end-50);
%     per_data(i,:) = per_temp;
%     
% %     per_data_lp(i,:) = abs(ifft(window_lp.*fft(per_data(i,:))));
%     
% %     f_temp = (f_temp(1:2000));
% %     per_temp = per_temp(1:2000);
%     
%     [Y, I] = max(per_data(i,:));
%     
%     solutions_per(i) = f_temp(I);
% %     solutions_rb(i) = frequency_rb(wmeas(i,:),1/(tmeas(2)-tmeas(1)));
%     f_roi = f_temp(I-roisize:I+roisize-1);
%     per_temp_roi = per_temp(I-roisize:I+roisize-1);
%     
%     solution_lse(i,:) = pnoise_fit_data(10*log10(per_temp_roi),f_roi,[roisize Y]);
% %     solution_lse(i,:) = pnoise_fit_data(10*log10(per_temp),f_temp,[I Y (mean(per_data(end-30:end)))]);
% 
%     solutions_lse(i) = f_roi(1) + solution_lse(i,1)*(f_roi(2)-f_roi(1));
% %     tau(i) = solution_lse(3);
%     
% %     [Y, I] = max(per_data_lp(i,:));
% %     solutions_per_lp(i) = f_temp(I);
% end
% 
% alpha = mean(solutions_per)/(340*10/8/3e8);
% 
% alpha = 1.279e7/(304*1.49/3e8);

% averaged_per = mean(per_data,1);
% pers = zeros(9,size(averaged_per,2));
% pers(9,:) = averaged_per;
%     
% figure(1);
% hold on;
% % plot(f_temp,10*log10(pnoise_model_data(solution_lse(end,:),f_temp)));
% plot(f_temp,10*log10(averaged_per));
% plot(f_roi,(pnoise_model_data(solution_lse(1,:),f_roi)));
% plot(f_roi,(pnoise_model_data(solution_lse(10,:),f_roi)));
% plot(f_roi,(pnoise_model_data(solution_lse(20,:),f_roi)));
% std(solutions_per)/std(solutions_lse)
% % xlim([0 2e7]);
% 
% % mean(solutions_per)*c/alpha/2
% % mean(solutions_lse)*c/alpha/2
% % 
% % d_lse = solutions_lse*c/alpha/2;
% std(solutions_lse)*c/alpha/2
% std(solutions_per)*c/alpha/2
% % % 
% edges=(200:1:240);
% figure(2);
% hold on;
% histogram(solutions_per*c/alpha/2,edges);
% histogram(solutions_lse*c/alpha/2,edges);
% histogram(solutions_per_lp*c/alpha/2,edges);

% plot(F,10*log10(averaged_per))
% 
% legend('30m','90m','150m','210m','270m');
% % F = F(1:2000);
% F = F';
% averaged_per = averaged_per(1:length(F));
% 
% solution_lse = pnoise_fit_data(averaged_per,F,[1000 0 0.7*8.626460257595531e-09]);
% solution = pnoise_model_data(solution_lse,F);

% figure(1);

